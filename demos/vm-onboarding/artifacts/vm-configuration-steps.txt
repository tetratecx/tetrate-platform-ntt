# gen certs
openssl req \
  -x509 \
  -subj '/CN=Example CA' \
  -days 3650 \
  -sha256 \
  -newkey rsa:2048 \
  -nodes \
  -keyout example-ca.key.pem \
  -out example-ca.crt.pem \
  -config <(cat <<EOF
[ req ]
distinguished_name     = req                 # name of a section containing the distinguished name fields to prompt for
x509_extensions        = v3_ca               # name of a section containing a list extentions to add to the self signed certificate
[ v3_ca ]
basicConstraints       = CA:TRUE             # not marked as critical for compatibility with broken software
subjectKeyIdentifier   = hash                # PKIX recommendation
authorityKeyIdentifier = keyid:always,issuer # PKIX recommendation
EOF
)

openssl req \
  -subj '/CN=onboarding-endpoint.example' \
  -sha256 \
  -newkey rsa:2048 \
  -nodes \
  -keyout onboarding-endpoint.example.key.pem \
  -out onboarding-endpoint.example.csr.pem

openssl x509 \
  -req \
  -days 3650 \
  -sha256 \
  -in onboarding-endpoint.example.csr.pem \
  -out onboarding-endpoint.example.crt.pem \
  -CA example-ca.crt.pem \
  -CAkey example-ca.key.pem \
  -CAcreateserial \
  -extfile <(cat <<EOF
extensions = usr_cert
[ usr_cert ]
basicConstraints       = CA:FALSE            # not marked as critical for compatibility with broken software
subjectKeyIdentifier   = hash                # PKIX recommendation
authorityKeyIdentifier = keyid:always,issuer # PKIX recommendation
keyUsage               = digitalSignature, keyEncipherment
extendedKeyUsage       = serverAuth
subjectAltName         = DNS:onboarding-endpoint.example
EOF
)

# create secret 

kubectl create secret tls onboarding-endpoint-tls-cert \
  -n istio-system \
  --cert=onboarding-endpoint.example.crt.pem \
  --key=onboarding-endpoint.example.key.pem

# patch cp for secret 

  meshExpansion:
    onboarding:
      endpoint:
        hosts:
        - onboarding-endpoint.example
        secretName: onboarding-endpoint-tls-cert

# Update package list
sudo apt-get update -y

# Install CA certificates package
sudo apt-get install -y ca-certificates

#copy example-ca.crt.pem to vm /usr/local/share/ca-certificates/example-ca.crt
sudo update-ca-certificates
1 added, 0 removed; done.

# Install Istio Sidecar
  # Download DEB package
ONBOARDING_ENDPOINT_ADDRESS=k8s-corpedge-vmgatewa-d2c3e53d79-7766c2fc1b8834f5.elb.us-east-2.amazonaws.com
curl -fLO \
  --connect-to "onboarding-endpoint.example:443:${ONBOARDING_ENDPOINT_ADDRESS}:443" \
  "https://onboarding-endpoint.example/install/deb/amd64/istio-sidecar.deb"

# Download checksum
curl -fLO \
  --connect-to "onboarding-endpoint.example:443:${ONBOARDING_ENDPOINT_ADDRESS}:443" \
  "https://onboarding-endpoint.example/install/deb/amd64/istio-sidecar.deb.sha256"

# Verify the checksum
sha256sum --check istio-sidecar.deb.sha256

# Install DEB package
sudo apt-get install -y ./istio-sidecar.deb

# Remove downloaded files
rm istio-sidecar.deb istio-sidecar.deb.sha256

#Install Workload Onboarding Agent - vmgateway svc in istio-system
export ONBOARDING_ENDPOINT_ADDRESS="34.130.140.124"

  # Download the agent package
curl -fLO \
  --connect-to "onboarding-endpoint.example:443:${ONBOARDING_ENDPOINT_ADDRESS}:443" \
  "https://onboarding-endpoint.example/install/deb/amd64/onboarding-agent.deb"

  # Download checksum
curl -fLO \
  --connect-to "onboarding-endpoint.example:443:${ONBOARDING_ENDPOINT_ADDRESS}:443" \
  "https://onboarding-endpoint.example/install/deb/amd64/onboarding-agent.deb.sha256"

  # Verify checksum
sha256sum --check onboarding-agent.deb.sha256

  # Install the agent
sudo apt-get install -y ./onboarding-agent.deb

  # Clean up
rm onboarding-agent.deb onboarding-agent.deb.sha256

# Create Onboarding Configuration

sudo mkdir -p /etc/onboarding-agent

cat <<EOF | sudo tee /etc/onboarding-agent/onboarding.config.yaml
apiVersion: config.agent.onboarding.tetrate.io/v1alpha1
kind: OnboardingConfiguration
onboardingEndpoint:
  host: ${ONBOARDING_ENDPOINT_ADDRESS}
  transportSecurity:
    tls:
      sni: onboarding-endpoint.example
workloadGroup:
  namespace: vm
  name: mysqldb
settings:
  connectedOver: INTERNET
EOF

  # Start Workload Onboarding Agent - Enable the service
sudo systemctl enable onboarding-agent

  # Start the service
sudo systemctl start onboarding-agent
sudo systemctl stop onboarding-agent

  # Check the status
sudo systemctl status onboarding-agent

  # Verify Agent Logs
sudo journalctl -u onboarding-agent -f

  # check if sidecar is running
curl -f -i http://localhost:15000/ready